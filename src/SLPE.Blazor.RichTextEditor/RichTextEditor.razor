@implements IAsyncDisposable
@inject IJSRuntime JS

<div id="@_editorId" class="rte-container">
    <div class="rte-toolbar" data-rte-toolbar>
        @* Undo / Redo *@
        <button type="button" class="rte-btn" data-command="undo" title="Undo (Ctrl+Z)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10h10a5 5 0 0 1 0 10H9"/><polyline points="7 14 3 10 7 6"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="redo" title="Redo (Ctrl+Y)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10H11a5 5 0 0 0 0 10h4"/><polyline points="17 14 21 10 17 6"/></svg>
        </button>

        <div class="rte-separator"></div>

        @* Block format *@
        <select class="rte-select" title="Block format">
            <option value="p">Normal</option>
            <option value="h1">Heading 1</option>
            <option value="h2">Heading 2</option>
            <option value="h3">Heading 3</option>
            <option value="h4">Heading 4</option>
            <option value="blockquote">Blockquote</option>
        </select>

        <div class="rte-separator"></div>

        @* Inline formatting *@
        <button type="button" class="rte-btn" data-command="bold" title="Bold (Ctrl+B)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 0 8H6z"/><path d="M6 12h9a4 4 0 0 1 0 8H6z"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="italic" title="Italic (Ctrl+I)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="underline" title="Underline (Ctrl+U)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v7a6 6 0 0 0 12 0V3"/><line x1="4" y1="21" x2="20" y2="21"/></svg>
        </button>

        <div class="rte-separator"></div>

        @* Alignment *@
        <button type="button" class="rte-btn" data-command="justifyLeft" title="Align left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="justifyCenter" title="Align center">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="justifyRight" title="Align right">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
        </button>

        <div class="rte-separator"></div>

        @* Lists *@
        <button type="button" class="rte-btn" data-command="insertUnorderedList" title="Bullet list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="9" y1="6" x2="20" y2="6"/><line x1="9" y1="12" x2="20" y2="12"/><line x1="9" y1="18" x2="20" y2="18"/><circle cx="4.5" cy="6" r="1" fill="currentColor"/><circle cx="4.5" cy="12" r="1" fill="currentColor"/><circle cx="4.5" cy="18" r="1" fill="currentColor"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="insertOrderedList" title="Numbered list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="10" y1="6" x2="20" y2="6"/><line x1="10" y1="12" x2="20" y2="12"/><line x1="10" y1="18" x2="20" y2="18"/><text x="3" y="8" font-size="7" fill="currentColor" stroke="none" font-family="sans-serif">1</text><text x="3" y="14" font-size="7" fill="currentColor" stroke="none" font-family="sans-serif">2</text><text x="3" y="20" font-size="7" fill="currentColor" stroke="none" font-family="sans-serif">3</text></svg>
        </button>

        <div class="rte-separator"></div>

        @* Indent *@
        <button type="button" class="rte-btn" data-command="outdent" title="Decrease indent">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="11" y1="12" x2="21" y2="12"/><line x1="11" y1="18" x2="21" y2="18"/><polyline points="7 9 3 13 7 17"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="indent" title="Increase indent">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="11" y1="12" x2="21" y2="12"/><line x1="11" y1="18" x2="21" y2="18"/><polyline points="3 9 7 13 3 17"/></svg>
        </button>

        <div class="rte-separator"></div>

        @* Link & Table *@
        <button type="button" class="rte-btn" data-command="link" title="Insert link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="table" title="Insert table">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        </button>

        <div class="rte-separator"></div>

        @* Code view & Fullscreen *@
        <button type="button" class="rte-btn" data-command="code" title="Source code">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
        </button>
        <button type="button" class="rte-btn" data-command="fullscreen" title="Fullscreen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
        </button>
    </div>

    <div class="rte-content" data-rte-content spellcheck="true" style="min-height: @(Height)px">
    </div>
    <textarea class="rte-code-view" data-rte-code spellcheck="false" style="min-height: @(Height)px"></textarea>
</div>

@code {
    [Parameter] public string Content { get; set; } = "";
    [Parameter] public EventCallback<string> ContentChanged { get; set; }
    [Parameter] public int Height { get; set; } = 500;
    [Parameter] public int DebounceMs { get; set; } = 300;
    [Parameter] public int UndoStackSize { get; set; } = 100;
    [Parameter] public int MaxTableRows { get; set; } = 20;
    [Parameter] public int MaxTableColumns { get; set; } = 10;

    private string _editorId = $"rte-{Guid.NewGuid():N}";
    private IJSObjectReference? _module;
    private DotNetObjectReference<RichTextEditor>? _dotNetRef;
    private string _lastContent = "";
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _module = await JS.InvokeAsync<IJSObjectReference>("import",
                "./_content/SLPE.Blazor.RichTextEditor/js/rich-text-editor.js");

            var options = new
            {
                debounceMs = DebounceMs,
                undoStackSize = UndoStackSize,
                maxTableRows = MaxTableRows,
                maxTableCols = MaxTableColumns
            };
            await _module.InvokeVoidAsync("initEditor", _editorId, _dotNetRef, options);

            if (!string.IsNullOrEmpty(Content))
            {
                _lastContent = Content;
                await _module.InvokeVoidAsync("setContent", _editorId, Content);
            }

            _initialized = true;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // If parent pushed new content (e.g. after save + reload), update the editor
        if (_initialized && _module is not null && Content != _lastContent)
        {
            _lastContent = Content;
            await _module.InvokeVoidAsync("setContent", _editorId, Content);
        }
    }

    [JSInvokable]
    public async Task OnContentChanged(string content)
    {
        _lastContent = content;
        Content = content;
        await ContentChanged.InvokeAsync(content);
    }

    public async Task<string> GetContentAsync()
    {
        if (_module is not null)
        {
            var content = await _module.InvokeAsync<string>("getContent", _editorId);
            _lastContent = content;
            return content;
        }
        return Content;
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("destroyEditor", _editorId);
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, nothing to clean up
            }
        }
        _dotNetRef?.Dispose();
    }
}
